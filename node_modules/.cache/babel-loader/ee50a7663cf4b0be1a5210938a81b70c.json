{"ast":null,"code":"import fetch from 'isomorphic-unfetch';\n// import { IS_WEB, IS_REACT_NATIVE } from './environment.const';\nimport { ApiError, ValidationError, PermissionError } from '../error/error.types'; // constants\n// import env from '../../server/env';\n// import { defaultLanguage } from '../app/languages';\n// import { mobileHeaders } from './api';\n\nexport function isValid(url, response) {\n  if (response.code === 401) {\n    throw new PermissionError(`Access denied [${response.code}] to ${url}`);\n  }\n\n  if (response.status !== 'ok') {\n    throw new ValidationError(`${response.code} ${response.data}`, {\n      code: response.code,\n      data: response.data\n    });\n  }\n\n  return response;\n} // `${env.api}${url}${url.includes('?') ? `&language=${lang}` : `?language=${lang}`}`\n\nexport default async function api(url, lang, options, headers) {\n  // const credentials: RequestCredentials = 'omit';\n  // const mode: RequestMode = 'cors';\n  try {\n    const request = fetch(`${url}`, Object.assign({}, {\n      headers: {\n        Accept: 'application/json',\n        'Content-Type': 'application/json',\n        // 'Accept-Language': lang || defaultLanguage,\n        // 'Content-Language': lang || defaultLanguage,\n        ...headers\n      } // mode,\n      // credentials,\n\n    }, options, options !== null && options !== void 0 && options.body && (options === null || options === void 0 ? void 0 : options.method) !== 'GET' ? {\n      body: JSON.stringify(options.body)\n    } : {}));\n    const result = await request;\n    let response = null;\n    console.log(\"response\", response);\n\n    if (result.headers.get('content-type') === 'application/json') {\n      response = await result.json();\n      console.log(\"result\", result);\n    } else {// throw new ValidationError('Json parsing error', {\n      //     code: result.status,\n      //     data: {\n      //         url,\n      //         method: options?.method,\n      //     },\n      // });\n    }\n\n    if (process.env.NODE_ENV === 'development') {\n      /* eslint-disable no-console */\n      console.group(`API Request Debug ${url}`);\n      console.info(`Url ${url}`);\n      console.info('Response', response);\n      console.groupCollapsed('Stack trace');\n      console.trace();\n      console.groupEnd();\n      console.groupEnd();\n      /* eslint-enable no-console */\n    } // return [isValid(url, response), result.headers];\n\n  } catch (e) {\n    if (e instanceof ValidationError || e instanceof PermissionError) {\n      throw e;\n    }\n\n    throw new ApiError(e.message, {\n      code: 500,\n      stack: e.stack\n    });\n  }\n}\nexport const pause = duration => new Promise(res => setTimeout(res, duration));\nexport async function retry(retries, fn, delay = 500, delayMultiply = 1) {\n  try {\n    return await fn();\n  } catch (e) {\n    if (retries > 1) {\n      await pause(delay);\n      return retry(retries - 1, fn, delay * delayMultiply);\n    }\n\n    throw e;\n  }\n}","map":{"version":3,"sources":["/home/yevgen/project/react-git-search-app/src/api/api.ts"],"names":["fetch","ApiError","ValidationError","PermissionError","isValid","url","response","code","status","data","api","lang","options","headers","request","Object","assign","Accept","body","method","JSON","stringify","result","console","log","get","json","process","env","NODE_ENV","group","info","groupCollapsed","trace","groupEnd","e","message","stack","pause","duration","Promise","res","setTimeout","retry","retries","fn","delay","delayMultiply"],"mappings":"AAAA,OAAOA,KAAP,MAAkB,oBAAlB;AAEA;AACA,SAASC,QAAT,EAAmBC,eAAnB,EAAoCC,eAApC,QAA2D,sBAA3D,C,CAEA;AACA;AACA;AACA;;AAIA,OAAO,SAASC,OAAT,CAAoBC,GAApB,EAAiCC,QAAjC,EAA6E;AAChF,MAAIA,QAAQ,CAACC,IAAT,KAAkB,GAAtB,EAA2B;AACvB,UAAM,IAAIJ,eAAJ,CAAqB,kBAAiBG,QAAQ,CAACC,IAAK,QAAOF,GAAI,EAA/D,CAAN;AACH;;AAED,MAAIC,QAAQ,CAACE,MAAT,KAAoB,IAAxB,EAA8B;AAC1B,UAAM,IAAIN,eAAJ,CAAqB,GAAEI,QAAQ,CAACC,IAAK,IAAGD,QAAQ,CAACG,IAAK,EAAtD,EAAyD;AAC3DF,MAAAA,IAAI,EAAED,QAAQ,CAACC,IAD4C;AAE3DE,MAAAA,IAAI,EAAEH,QAAQ,CAACG;AAF4C,KAAzD,CAAN;AAIH;;AACD,SAAOH,QAAP;AACH,C,CAED;;AACA,eAAe,eAAeI,GAAf,CACXL,GADW,EAEXM,IAFW,EAGXC,OAHW,EAIXC,OAJW,EAK4B;AACvC;AACA;AACA,MAAI;AACA,UAAMC,OAAO,GAAGd,KAAK,CAChB,GAAEK,GAAI,EADU,EAEjBU,MAAM,CAACC,MAAP,CACI,EADJ,EAEI;AACIH,MAAAA,OAAO,EAAE;AACLI,QAAAA,MAAM,EAAE,kBADH;AAEL,wBAAgB,kBAFX;AAGL;AACA;AACA,WAAGJ;AALE,OADb,CAQI;AACA;;AATJ,KAFJ,EAaID,OAbJ,EAcIA,OAAO,SAAP,IAAAA,OAAO,WAAP,IAAAA,OAAO,CAAEM,IAAT,IAAiB,CAAAN,OAAO,SAAP,IAAAA,OAAO,WAAP,YAAAA,OAAO,CAAEO,MAAT,MAAoB,KAArC,GAA6C;AAAED,MAAAA,IAAI,EAAEE,IAAI,CAACC,SAAL,CAAeT,OAAO,CAACM,IAAvB;AAAR,KAA7C,GAAsF,EAd1F,CAFiB,CAArB;AAmBA,UAAMI,MAAM,GAAG,MAAMR,OAArB;AACA,QAAIR,QAAqB,GAAG,IAA5B;AACAiB,IAAAA,OAAO,CAACC,GAAR,CAAY,UAAZ,EAAwBlB,QAAxB;;AAEA,QAAIgB,MAAM,CAACT,OAAP,CAAeY,GAAf,CAAmB,cAAnB,MAAuC,kBAA3C,EAA+D;AAC3DnB,MAAAA,QAAQ,GAAG,MAAMgB,MAAM,CAACI,IAAP,EAAjB;AACAH,MAAAA,OAAO,CAACC,GAAR,CAAY,QAAZ,EAAsBF,MAAtB;AACH,KAHD,MAGO,CACH;AACA;AACA;AACA;AACA;AACA;AACA;AACH;;AAED,QAAIK,OAAO,CAACC,GAAR,CAAYC,QAAZ,KAAyB,aAA7B,EAA4C;AACxC;AACAN,MAAAA,OAAO,CAACO,KAAR,CAAe,qBAAoBzB,GAAI,EAAvC;AACAkB,MAAAA,OAAO,CAACQ,IAAR,CAAc,OAAM1B,GAAI,EAAxB;AACAkB,MAAAA,OAAO,CAACQ,IAAR,CAAa,UAAb,EAAyBzB,QAAzB;AACAiB,MAAAA,OAAO,CAACS,cAAR,CAAuB,aAAvB;AACAT,MAAAA,OAAO,CAACU,KAAR;AACAV,MAAAA,OAAO,CAACW,QAAR;AACAX,MAAAA,OAAO,CAACW,QAAR;AACA;AACH,KA/CD,CAiDA;;AACH,GAlDD,CAkDE,OAAOC,CAAP,EAAU;AACR,QAAIA,CAAC,YAAYjC,eAAb,IAAgCiC,CAAC,YAAYhC,eAAjD,EAAkE;AAC9D,YAAMgC,CAAN;AACH;;AAED,UAAM,IAAIlC,QAAJ,CAAakC,CAAC,CAACC,OAAf,EAAwB;AAC1B7B,MAAAA,IAAI,EAAE,GADoB;AAE1B8B,MAAAA,KAAK,EAAEF,CAAC,CAACE;AAFiB,KAAxB,CAAN;AAIH;AACJ;AAED,OAAO,MAAMC,KAAK,GAAIC,QAAD,IACjB,IAAIC,OAAJ,CAAYC,GAAG,IAAIC,UAAU,CAACD,GAAD,EAAMF,QAAN,CAA7B,CADG;AAIP,OAAO,eAAeI,KAAf,CACHC,OADG,EAEHC,EAFG,EAGHC,KAAK,GAAG,GAHL,EAIHC,aAAa,GAAG,CAJb,EAKO;AACV,MAAI;AACA,WAAO,MAAMF,EAAE,EAAf;AACH,GAFD,CAEE,OAAOV,CAAP,EAAU;AACR,QAAIS,OAAO,GAAG,CAAd,EAAiB;AACb,YAAMN,KAAK,CAACQ,KAAD,CAAX;AACA,aAAOH,KAAK,CAACC,OAAO,GAAG,CAAX,EAAcC,EAAd,EAAkBC,KAAK,GAAGC,aAA1B,CAAZ;AACH;;AACD,UAAMZ,CAAN;AACH;AACJ","sourcesContent":["import fetch from 'isomorphic-unfetch';\nimport type http from 'http';\n// import { IS_WEB, IS_REACT_NATIVE } from './environment.const';\nimport { ApiError, ValidationError, PermissionError } from '../error/error.types';\n\n// constants\n// import env from '../../server/env';\n// import { defaultLanguage } from '../app/languages';\n// import { mobileHeaders } from './api';\n\nimport type { Response, Options } from './api.types';\n\nexport function isValid<T>(url: string, response: Response<T>): Response<T> | never {\n    if (response.code === 401) {\n        throw new PermissionError(`Access denied [${response.code}] to ${url}`);\n    }\n\n    if (response.status !== 'ok') {\n        throw new ValidationError(`${response.code} ${response.data}`, {\n            code: response.code,\n            data: response.data,\n        });\n    }\n    return response;\n}\n\n// `${env.api}${url}${url.includes('?') ? `&language=${lang}` : `?language=${lang}`}`\nexport default async function api<T>(\n    url: string,\n    lang?: string,\n    options?: Options,\n    headers?: http.OutgoingHttpHeaders,\n): Promise<[Response<T>, Headers]> | never {\n    // const credentials: RequestCredentials = 'omit';\n    // const mode: RequestMode = 'cors';\n    try {\n        const request = fetch(\n            `${url}`,\n            Object.assign(\n                {},\n                {\n                    headers: {\n                        Accept: 'application/json',\n                        'Content-Type': 'application/json',\n                        // 'Accept-Language': lang || defaultLanguage,\n                        // 'Content-Language': lang || defaultLanguage,\n                        ...headers,\n                    },\n                    // mode,\n                    // credentials,\n                },\n                options,\n                options?.body && options?.method !== 'GET' ? { body: JSON.stringify(options.body) } : {},\n            ),\n        );\n        const result = await request;\n        let response: Response<T> = null!;\n        console.log(\"response\", response)\n\n        if (result.headers.get('content-type') === 'application/json') {\n            response = await result.json();\n            console.log(\"result\", result)\n        } else {\n            // throw new ValidationError('Json parsing error', {\n            //     code: result.status,\n            //     data: {\n            //         url,\n            //         method: options?.method,\n            //     },\n            // });\n        }\n\n        if (process.env.NODE_ENV === 'development') {\n            /* eslint-disable no-console */\n            console.group(`API Request Debug ${url}`);\n            console.info(`Url ${url}`);\n            console.info('Response', response);\n            console.groupCollapsed('Stack trace');\n            console.trace();\n            console.groupEnd();\n            console.groupEnd();\n            /* eslint-enable no-console */\n        }\n\n        // return [isValid(url, response), result.headers];\n    } catch (e) {\n        if (e instanceof ValidationError || e instanceof PermissionError) {\n            throw e;\n        }\n\n        throw new ApiError(e.message, {\n            code: 500,\n            stack: e.stack,\n        });\n    }\n}\n\nexport const pause = (duration: number): Promise<void> =>\n    new Promise(res => setTimeout(res, duration));\n\n\nexport async function retry<T>(\n    retries: number,\n    fn: () => Promise<T>,\n    delay = 500,\n    delayMultiply = 1,\n): Promise<T> {\n    try {\n        return await fn();\n    } catch (e) {\n        if (retries > 1) {\n            await pause(delay);\n            return retry(retries - 1, fn, delay * delayMultiply);\n        }\n        throw e;\n    }\n}\n"]},"metadata":{},"sourceType":"module"}